name: Deploy OpenWebUI Extensions

on:
  push:
    branches: [ main ]                            # ğŸš€ only main auto-deploys
    paths:
      - 'src/openwebui_devtoolkit/**.py'          # run only if a plugin changed
      - 'scripts/publish_to_webui.py'

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1.  STAGING  (GLC)  â€” automatic
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging-glc                      # uses staging-glc secrets

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - run: pip install requests python-dotenv

      # â† list all changed plugin files (works for merge commits too)
      - name: Get changed plugin files
        id: changed
        uses: tj-actions/changed-files@v43
        with:
          files: |
            src/openwebui_devtoolkit/pipes/**/*.py
            src/openwebui_devtoolkit/filters/**/*.py
            src/openwebui_devtoolkit/tools/**/*.py

      - name: Publish to GLC
        if: steps.changed.outputs.any_changed == 'true'
        env:
          WEBUI_URL: ${{ secrets.WEBUI_URL }}
          WEBUI_KEY: ${{ secrets.WEBUI_KEY }}
        run: |
          for file in ${{ steps.changed.outputs.changed_files }}; do
            echo "Publishing $file to GLC â€¦"
            python scripts/publish_to_webui.py "$file"
          done

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2.  PRODUCTION  (CLAC)  â€” manual approval gate
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-production:
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment:                                   # â¸ waits for approval
      name: production-clac
      url:  https://ai.clac.ca

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - run: pip install requests python-dotenv

      - name: Get changed plugin files
        id: changed
        uses: tj-actions/changed-files@v43
        with:
          files: |
            src/openwebui_devtoolkit/pipes/**/*.py
            src/openwebui_devtoolkit/filters/**/*.py
            src/openwebui_devtoolkit/tools/**/*.py

      - name: Publish to CLAC
        if: steps.changed.outputs.any_changed == 'true'
        env:
          WEBUI_URL: ${{ secrets.WEBUI_URL }}
          WEBUI_KEY: ${{ secrets.WEBUI_KEY }}
        run: |
          for file in ${{ steps.changed.outputs.changed_files }}; do
            echo "Publishing $file to CLAC â€¦"
            python scripts/publish_to_webui.py "$file"
          done
